<!-- redeploy -->
<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Love Journal</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cormorant+Garamond:wght@500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">

  <style>
    :root{
      --bg0:#07070b;
      --bg1:#0b0b12;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --border: rgba(255,255,255,0.12);

      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.74);
      --muted2: rgba(255,255,255,0.54);

      --ok: rgba(165, 255, 210, 0.95);
      --err: rgba(255, 150, 150, 0.95);

      --radius: 18px;
      --radius2: 24px;

      --shadow: 0 22px 70px rgba(0,0,0,0.65);
      --shadow2: 0 12px 38px rgba(0,0,0,0.45);

      --serif: "Cormorant Garamond", ui-serif, Georgia, "Times New Roman", serif;
      --sans: "Inter", ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif;

      --ease: cubic-bezier(.2,.9,.2,1);
    }

    *{ box-sizing:border-box; }
    html, body{ height:100%; }
    body{
      margin:0;
      color: var(--text);
      background:
              radial-gradient(1100px 700px at 20% 12%, rgba(255,255,255,0.08), transparent 58%),
              radial-gradient(900px 700px at 85% 25%, rgba(255,255,255,0.06), transparent 60%),
              radial-gradient(1000px 700px at 50% 100%, rgba(255,255,255,0.05), transparent 58%),
              linear-gradient(180deg, var(--bg0), var(--bg1));
      padding: 18px;
      
      display: block;
      overflow-x: hidden;
    }


    body:before{
      content:"";
      position:fixed;
      inset:0;
      pointer-events:none;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='140' height='140'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='.8' numOctaves='3' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='140' height='140' filter='url(%23n)' opacity='.18'/%3E%3C/svg%3E");
      opacity:.18;
      mix-blend-mode: overlay;
    }

    .app{
      width: min(1020px, 100%);
      margin: 18px auto;
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,0.10);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.03));
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }

    .topbar{
      display:flex;
      align-items:center;
      justify-content:space-between;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.22);
      gap: 12px;
    }

    .brand{
      display:flex;
      gap: 12px;
      align-items:center;
      min-width: 220px;
    }

    .sigil{
      width: 36px; height: 36px;
      border-radius: 14px;
      background: radial-gradient(circle at 30% 30%, rgba(255,255,255,0.18), rgba(255,255,255,0.04));
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 10px 26px rgba(0,0,0,0.35);
      display:grid;
      place-items:center;
      font-family: var(--serif);
      font-weight:700;
      letter-spacing: 0.2px;
    }

    .brand h1{
      margin:0;
      font-family: var(--serif);
      font-size: 18px;
      letter-spacing: 0.6px;
      font-weight: 700;
      line-height: 1.05;
    }
    .brand .sub{
      font-family: var(--sans);
      font-size: 12px;
      color: var(--muted2);
      letter-spacing: 0.2px;
      margin-top: 2px;
    }

    .actions{
      display:flex;
      gap: 10px;
      align-items:center;
      flex-wrap:wrap;
      justify-content:flex-end;
    }

    button{
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-family: var(--sans);
      font-weight:600;
      letter-spacing: 0.15px;
      transition: transform .08s ease, background .18s ease, border .18s ease, box-shadow .18s ease;
      display:inline-flex;
      align-items:center;
      gap: 8px;
      user-select:none;
    }
    button:hover{
      background: rgba(255,255,255,0.10);
      border-color: rgba(255,255,255,0.22);
      box-shadow: 0 10px 24px rgba(0,0,0,0.25);
    }
    button:active{ transform: translateY(1px); }
    button[disabled]{ opacity:0.45; cursor:not-allowed; box-shadow:none; }

    .btn-ghost{
      background: transparent;
      border-color: rgba(255,255,255,0.14);
    }
    .btn-danger{
      border-color: rgba(255,140,140,0.30);
    }

    .layout{
      display:grid;
      grid-template-columns: 1fr 340px;
      min-height: 620px;
    }

    @media (max-width: 920px){
      .layout{ grid-template-columns: 1fr; }
      .sidebar{ order:-1; border-left:none; border-bottom: 1px solid rgba(255,255,255,0.10); }
      .brand{ min-width:auto; }
    }

    .stage{
      padding: 18px;
    }

    .sidebar{
      padding: 18px;
      border-left: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.14);
    }

    .panel{
      background: var(--panel);
      border: 1px solid var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      padding: 16px;
    }

    .panel + .panel{ margin-top: 14px; }

    .kicker{
      font-family: var(--sans);
      text-transform: uppercase;
      font-size: 11px;
      letter-spacing: 0.16em;
      color: var(--muted2);
      margin: 0 0 8px 0;
    }

    .title{
      font-family: var(--serif);
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.3px;
      margin: 0 0 10px 0;
    }

    .prose{
      font-family: var(--serif);
      font-size: 18px;
      line-height: 1.55;
      color: rgba(255,255,255,0.88);
      white-space: pre-line;
      margin: 10px 0 0;
    }

    .muted{
      font-family: var(--sans);
      color: var(--muted);
      font-size: 14px;
      line-height: 1.55;
      white-space: pre-line;
      margin: 10px 0 0;
    }

    .divider{
      height: 1px;
      background: rgba(255,255,255,0.10);
      margin: 14px 0;
    }

    .scene{
      position:relative;
    }
    
    .scene.fade-in{
      animation: sceneIn .42s var(--ease) both;
    }
    @keyframes sceneIn{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    .callout{
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.04);
      padding: 14px;
      margin-top: 12px;
    }
    .callout .prose{
      font-size: 17px;
      margin:0;
      color: rgba(255,255,255,0.86);
    }

    .input-row{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 12px;
    }

    input[type="text"]{
      flex: 1;
      min-width: 240px;
      padding: 12px 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.18);
      outline: none;
      background: rgba(0,0,0,0.22);
      color: var(--text);
      font-family: var(--sans);
      font-size: 15px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.25);
      transition: border .18s ease, background .18s ease, box-shadow .18s ease;
    }
    input[type="text"]:focus{
      border-color: rgba(255,255,255,0.28);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.30), 0 0 0 6px rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.28);
    }

    .msg{
      margin-top: 12px;
      font-family: var(--sans);
      font-size: 14px;
      line-height: 1.45;
      color: var(--muted);
      white-space: pre-line;
    }
    .msg.ok{ color: var(--ok); }
    .msg.err{ color: var(--err); }

    .hint{
      margin-top: 8px;
      font-family: var(--sans);
      font-size: 13px;
      color: var(--muted2);
      display:none;
    }
    .hint.show{ display:block; }

    .choices{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 12px;
    }

    .choice{
      width:100%;
      justify-content:flex-start;
      padding: 12px 14px;
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: 0 10px 20px rgba(0,0,0,0.18);
      text-align:left;
    }
    .choice:hover{ background: rgba(255,255,255,0.09); }

    
    .journal-list{
      display:flex;
      flex-direction:column;
      gap: 10px;
      margin-top: 10px;
    }

    .word-row{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap: 10px;
      padding: 10px 12px;
      border-radius: 16px;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
    }

    .word-row .w{
      font-family: var(--serif);
      font-weight: 700;
      letter-spacing: 0.12em;
      font-size: 14px;
    }

    .word-row.locked .w{
      letter-spacing: 0.22em;
      color: rgba(255,255,255,0.58);
    }

    .badge{
      font-family: var(--sans);
      font-size: 12px;
      color: var(--muted2);
    }

    .progress{
      font-family: var(--sans);
      font-size: 13px;
      color: var(--muted2);
      line-height: 1.45;
      margin-top: 10px;
      white-space: pre-line;
    }

    .chip{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 8px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.04);
      font-family: var(--sans);
      font-size: 12px;
      color: var(--muted2);
      margin-top: 10px;
    }

    
    .modal{
      position:fixed;
      inset:0;
      display:none;
      align-items:center;
      justify-content:center;
      padding: 18px;
      background: rgba(0,0,0,0.60);
      backdrop-filter: blur(8px);
      z-index: 50;
    }
    .modal.show{ display:flex; }
    .modal .sheet{
      width: min(820px, 100%);
      border-radius: var(--radius2);
      background: rgba(14,14,22,0.96);
      border: 1px solid rgba(255,255,255,0.14);
      box-shadow: var(--shadow);
      overflow:hidden;
      animation: sheetIn .28s var(--ease) both;
    }
    @keyframes sheetIn{
      from{ opacity:0; transform: translateY(10px) scale(0.99); }
      to{ opacity:1; transform: translateY(0) scale(1); }
    }

    .sheet-header{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 14px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      background: rgba(255,255,255,0.03);
    }
    .sheet-title{
      display:flex;
      flex-direction:column;
      gap: 2px;
    }
    .sheet-title .h{
      font-family: var(--serif);
      font-size: 18px;
      font-weight: 700;
      letter-spacing: 0.5px;
      margin:0;
    }
    .sheet-title .s{
      font-family: var(--sans);
      font-size: 12px;
      color: var(--muted2);
      margin:0;
    }
    .sheet-body{
      padding: 16px;
    }

    .bigwords{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .bigword{
      display:flex;
      justify-content:space-between;
      align-items:center;
      padding: 14px 14px;
      border-radius: 18px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
    }
    .bigword .left{
      font-family: var(--serif);
      font-size: 16px;
      font-weight: 700;
      letter-spacing: 0.14em;
    }
    .bigword .state{
      font-family: var(--sans);
      font-size: 12px;
      color: var(--muted2);
    }

    .final-actions{
      margin-top: 14px;
      display:flex;
      flex-direction:column;
      gap: 10px;
    }

    .note{
      margin-top: 12px;
      font-family: var(--sans);
      font-size: 12px;
      color: var(--muted2);
      line-height: 1.45;
      white-space: pre-line;
    }

    @media (prefers-reduced-motion: reduce){
      *{ animation:none !important; transition:none !important; }
    }
  </style>
</head>

<body>
<div class="app">
  <div class="topbar">
    <div class="brand">
      
      <div>
        <h1>Love Journal</h1>
        <div class="sub">A tale bound by choice, presence, and a question held with care.</div>
      </div>
    </div>

    <div class="actions">
      <button class="btn-ghost" id="btnJournal">üìñ Journal</button>
      <button class="btn-ghost btn-danger" id="btnReset">Reset</button>
    </div>
  </div>

  <div class="layout">
    <div class="stage">
      <div class="panel scene fade-in" id="scene"></div>
    </div>

    <div class="sidebar">
      <div class="panel">
        <div class="kicker">Journal</div>
        <div class="title">Words Gathered</div>
        <div class="journal-list" id="journalMini"></div>
        <div class="progress" id="progressText"></div>
      </div>

      <div class="panel">
        <div class="kicker">Tip</div>
        <div class="muted" style="margin:0;">
          If you ever get stuck, read the text again slowly.
          The answers are always nearby.
        </div>
      </div>
    </div>
  </div>
</div>


<div class="modal" id="modal">
  <div class="sheet" role="dialog" aria-modal="true" aria-label="Journal">
    <div class="sheet-header">
      <div class="sheet-title">
        <p class="h">Journal</p>
      </div>
      <button class="btn-ghost" id="btnClose">Close</button>
    </div>
    <div class="sheet-body" id="modalBody"></div>
  </div>
</div>

<script>
  const STORAGE_KEY = "love_journal_v2";

  const WORD_KEYS = ["WILL","YOU","BE","MY","VALENTINE?"];
  const defaultState = () => ({
    step: "start",
    attempts: { l1: 0, l2: 0 },
    removed: [],             
    words: WORD_KEYS.map(k => ({ key: k, unlocked: false })),
    endMessage: "Some answers are not meant for screens.\nI‚Äôm waiting for you."
  });

  let state = loadState();

  function loadState(){
    try{
      const raw = localStorage.getItem(STORAGE_KEY);
      if(!raw) return defaultState();
      const parsed = JSON.parse(raw);
      if(!parsed.words || !Array.isArray(parsed.words)) return defaultState();
      return { ...defaultState(), ...parsed };
    }catch{
      return defaultState();
    }
  }

  function saveState(){
    localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  }

  function resetState(){
    state = defaultState();
    saveState();
    render();
  }

  function unlock(key){
    const w = state.words.find(x => x.key === key);
    if(w) w.unlocked = true;
    saveState();
    renderMiniJournal();
  }

  function has(key){
    return !!state.words.find(w => w.key===key && w.unlocked);
  }

  function nextStepFromProgress(){
    if(!has("WILL")) return "l1";
    if(!has("YOU")) return "l2";
    if(!has("BE")) return "l3";
    if(!has("MY")) return "l4";
    if(!has("VALENTINE?")) return "final";
    return "end";
  }

  function normalize(s){
    return (s || "").trim().toUpperCase().replace(/\s+/g," ");
  }

 
  const scene = document.getElementById("scene");
  const journalMini = document.getElementById("journalMini");
  const progressText = document.getElementById("progressText");

  const modal = document.getElementById("modal");
  const modalBody = document.getElementById("modalBody");

  document.getElementById("btnReset").addEventListener("click", () => {
    if(confirm("Reset progress? This will clear the journal and restart the story.")){
      resetState();
    }
  });

  document.getElementById("btnJournal").addEventListener("click", openJournal);
  document.getElementById("btnClose").addEventListener("click", closeJournal);
  modal.addEventListener("click", (e) => { if(e.target === modal) closeJournal(); });

  function openJournal(){
    renderJournalModal();
    modal.classList.add("show");
  }
  function closeJournal(){
    modal.classList.remove("show");
  }

  function renderMiniJournal(){
    journalMini.innerHTML = "";
    for(const w of state.words){
      const row = document.createElement("div");
      row.className = "word-row" + (w.unlocked ? "" : " locked");
      row.innerHTML = `
          <div class="w">${w.unlocked ? w.key : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"}</div>
          <div class="badge">${w.unlocked ? "unlocked" : "locked"}</div>
        `;
      journalMini.appendChild(row);
    }
    const unlockedCount = state.words.filter(w => w.unlocked).length;
    if(unlockedCount < 4){
      progressText.textContent = `Words gathered: ${unlockedCount}/5.\n`;
    }else if(unlockedCount === 4){
      progressText.textContent = `Words gathered: 4/5.\nOne page remains.`;
    }else{
      progressText.textContent = `Words gathered: 5/5.\nThe journal remembers.`;
    }
  }

  function renderJournalModal(){
    const entries = state.words.map(w => {
      const shown = w.unlocked ? w.key : "‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢";
      const st = w.unlocked ? "unlocked" : "locked";
      return `
          <div class="bigword">
            <div class="left">${shown}</div>
            <div class="state">${st}</div>
          </div>
        `;
    }).join("");

    let finalBlock = "";
    if(has("VALENTINE?")){
      finalBlock = `
          <div class="divider"></div>
          <div class="muted" style="margin:0;">
The words are already written.\nOnly one thing remains.
          </div>
          <div class="final-actions">
            <button class="choice" id="finalStep">Yes</button>
            <button class="choice" id="finalClose">No</button>
          </div>
          <div class="note">
This story will not force your answer.
It only makes space for it.
          </div>
        `;
    }

    modalBody.innerHTML = `
        <div class="muted" style="margin:0;">
What you have gathered remains.\nQuietly. Surely.
        </div>
        <div class="bigwords">${entries}</div>
        ${finalBlock}
      `;

    if(has("VALENTINE?")){
      const btnStep = document.getElementById("finalStep");
      const btnClose = document.getElementById("finalClose");

      btnClose.addEventListener("click", () => {
        
        modalBody.insertAdjacentHTML("beforeend", `
            <div class="divider"></div>
            <div class="muted" style="margin:0;">
Some answers need time.\nThere is no rush.
            </div>
          `);
        btnClose.disabled = true;
        setTimeout(() => renderJournalModal(), 700);
      });

      btnStep.addEventListener("click", () => {
        closeJournal();
        state.step = "end";
        saveState();
        render();
      });
    }
  }

  function setScene(html){
   
    scene.classList.remove("fade-in");
    scene.innerHTML = html;
    
    void scene.offsetWidth;
    scene.classList.add("fade-in");
  }

 
  function render(){
    renderMiniJournal();

   
    const should = nextStepFromProgress();
    const order = ["start","l1","l2","l3","l4","final","end"];
    if(order.indexOf(should) > order.indexOf(state.step)){
      state.step = should;
      saveState();
    }

    switch(state.step){
      case "start": return renderStart();
      case "l1": return renderL1();
      case "l2": return renderL2();
      case "l3": return renderL3();
      case "l4": return renderL4();
      case "final": return renderFinal();
      case "end": return renderEnd();
      default:
        state.step = "start"; saveState(); return renderStart();
    }
  }

  function renderStart(){
    setScene(`
        <div class="kicker">Begin</div>
        <div class="title">A quiet journey</div>
        <div class="muted">
You will gather five words.
Each step is saved automatically.
        </div>

        <div class="divider"></div>

        <div class="muted" style="margin:0;">
When you‚Äôre ready‚Äî
        </div>

        <div class="input-row">
          <button id="btnBegin">‚ñ∂ Begin</button>
          <button class="btn-ghost" id="btnContinue" ${nextStepFromProgress()==="l1" ? "disabled" : ""}>Continue</button>
        </div>

        <div class="note">
        </div>
      `);

    document.getElementById("btnBegin").addEventListener("click", () => {
      state.step = "l1"; saveState(); render();
    });
    document.getElementById("btnContinue").addEventListener("click", () => {
      state.step = nextStepFromProgress(); saveState(); render();
    });
    document.getElementById("btnOpenJ").addEventListener("click", openJournal);
  }

  // Level 1 ‚Äî WILL
  function renderL1(){
    const showHint = state.attempts.l1 >= 1;

    setScene(`
        <div class="kicker">Level 1</div>
        <div class="title">The Hall of Choosing</div>
        <div class="muted">
You awaken in a vast obsidian hall.
Three doors stand before you, etched with ancient runes.
Below them, a stone tablet glows.
        </div>

        <div class="callout">
          <p class="prose"><strong>W</strong>hen the world demands you kneel
<strong>I</strong>n the face of fear and doubt
<strong>L</strong>egends are not born by chance
<strong>L</strong>eaving choice to no one else</p>
        </div>

        <div class="divider"></div>

        <div class="muted" style="margin:0;">Type the word this hall is testing:</div>
        <div class="input-row">
          <input id="in" type="text" placeholder="Enter one word‚Ä¶" autocomplete="off" />
          <button id="go">Answer</button>
        </div>

        <div class="hint ${showHint ? "show" : ""}" id="hint">Hint: Sometimes, the first steps matter most.</div>
        <div class="msg" id="msg"></div>
      `);

    const jBtn = document.getElementById("j");
    if (jBtn) jBtn.addEventListener("click", openJournal);

    const input = document.getElementById("in");
    const msg = document.getElementById("msg");

    document.getElementById("go").addEventListener("click", () => {
      if(normalize(input.value) === "WILL"){
        msg.className = "msg ok";
        msg.textContent = "The door marked Will hums softly. The others fade into shadow.";
        unlock("WILL");
        state.step = "l2"; saveState();
        setTimeout(render, 5500);
      }else{
        state.attempts.l1++;
        saveState();
        document.getElementById("hint").classList.add("show");
        msg.className = "msg err";
        msg.textContent = "The runes remain cold. The hall does not respond.";
      }
    });
  }

  // Level 2 ‚Äî YOU
  function renderL2(){
    const showHint = state.attempts.l2 >= 1;

    setScene(`
        <div class="kicker">Level 2</div>
        <div class="title">The Mirror of Truth</div>
        <div class="muted">
You step into a quiet chamber.
A mirror of moonstone reflects words instead of faces.

‚ÄúTruth does not need to be proven.‚Äù
        </div>

        <div class="callout">
          <p class="prose">You are not here by chance.
You are not unseen.

Every step has led to this moment.
Every choice has brought <em>you</em> here.</p>
        </div>

        <div class="divider"></div>

        <div class="muted" style="margin:0;">The mirror reflects who it speaks to:</div>
        <div class="input-row">
          <input id="in" type="text" placeholder="Enter one word‚Ä¶" autocomplete="off" />
          <button id="go">Answer</button>
        </div>

        <div class="hint ${showHint ? "show" : ""}" id="hint">Hint: Every line began the same way.</div>
        <div class="msg" id="msg"></div>
      `);

    const jBtn = document.getElementById("j");
    if (jBtn) jBtn.addEventListener("click", openJournal);

    const input = document.getElementById("in");
    const msg = document.getElementById("msg");

    document.getElementById("go").addEventListener("click", () => {
      if(normalize(input.value) === "YOU"){
        msg.className = "msg ok";
        msg.textContent = "The mirror brightens. It never asked who you wished to be, only who you already are.";
        unlock("YOU");
        state.step = "l3"; saveState();
        setTimeout(render, 5500);
      }else{
        state.attempts.l2++;
        saveState();
        document.getElementById("hint").classList.add("show");
        msg.className = "msg err";
        msg.textContent = "The mirror remains clear, but silent.";
      }
    });
  }

  // Level 3 ‚Äî BE
  function renderL3(){
    setScene(`
        <div class="kicker">Level 3</div>
        <div class="title">The Crossing</div>
        <div class="muted">
A bridge lies shattered above endless dark.
Two stone markers face one another, unmoving.

‚ÄúSome journeys are not crossed alone.‚Äù
        </div>

        <div class="divider"></div>

        <div class="muted" style="margin:0;">Choose when you would step forward:</div>
        <div class="choices">
          <button class="choice" data-opt="1">1Ô∏è‚É£ When fear is quiet</button>
          <button class="choice" data-opt="2">2Ô∏è‚É£ When you are unsure, but not alone</button>
          <button class="choice" data-opt="3">3Ô∏è‚É£ When everything is certain</button>
        </div>

        <div class="msg" id="msg"></div>
      `);

    const jBtn = document.getElementById("j");
    if (jBtn) jBtn.addEventListener("click", openJournal);

    const msg = document.getElementById("msg");
    scene.querySelectorAll("button.choice").forEach(b => {
      b.addEventListener("click", () => {
        const opt = b.getAttribute("data-opt");
        if(opt === "2"){
          msg.className = "msg ok";
          msg.textContent = "You step forward. Another step echoes beside yours. Stone shifts, light forms and the bridge rises beneath your feet.";
          unlock("BE");
          state.step = "l4"; saveState();
          setTimeout(render, 5500);
        }else if(opt === "1"){
          msg.className = "msg err";
          msg.textContent = "You wait. Fear does not fade. The bridge remains broken.\n‚ÄúFear is not the enemy.‚Äù";
        }else{
          msg.className = "msg err";
          msg.textContent = "You hesitate. Certainty never arrives.\n‚ÄúSome things cannot wait.‚Äù";
        }
      });
    });
  }

  // Level 4 ‚Äî MY
  function renderL4(){
    const words = ["MINE","FATE","YOURS","MY","OURS"];
    state.removed = (state.removed || []).filter(w => words.includes(w));
    const remaining = words.filter(w => !state.removed.includes(w));
    const done = (remaining.length === 1 && remaining[0] === "MY");

    if(done && !has("MY")) unlock("MY");

    const listButtons = remaining.map(w => `<button class="choice" data-w="${w}">${w}</button>`).join("");

    setScene(`
        <div class="kicker">Level 4</div>
        <div class="title">The Chamber of Belonging</div>
        <div class="muted">
The chamber is quiet.
Nothing waits to be taken here.

‚ÄúBelonging is not claimed.
It remains only when all else falls away.‚Äù
        </div>

        <div class="divider"></div>

        <div class="muted" style="margin:0;">Remove the words that do not belong:</div>
        <div class="choices" id="list">
          ${listButtons}
        </div>

        <div class="msg" id="msg"></div>

        <div class="divider"></div>

        <div class="input-row">
          <button id="continue" ${done ? "" : "disabled"}>Continue</button>
        </div>
      `);

    const jBtn = document.getElementById("j");
    if (jBtn) jBtn.addEventListener("click", openJournal);

    const msg = document.getElementById("msg");
    const mapLine = {
      "FATE": "‚ÄúBelonging is not decided for you.‚Äù",
      "MINE": "‚ÄúNothing here is taken.‚Äù",
      "YOURS": "‚ÄúThis chamber does not demand.‚Äù",
      "OURS": "‚ÄúTogether comes later.‚Äù"
    };

    document.getElementById("list").querySelectorAll("button.choice").forEach(b => {
      b.addEventListener("click", () => {
        const w = b.getAttribute("data-w");
        if(w === "MY" && remaining.length > 1){
          msg.className = "msg";
          msg.textContent = "Not yet.";
          return;
        }
        if(w !== "MY"){
          state.removed.push(w);
          saveState();
          msg.className = "msg ok";
          msg.textContent = `${w} fades away.\n${mapLine[w] || ""}`.trim();
          document.querySelectorAll('#list button.choice').forEach(x => x.disabled = true);
          setTimeout(render, 2700);
        }else{
          // Only MY remains
          unlock("MY");
          msg.className = "msg ok";
          msg.textContent = "What remains is what was offered.";
          document.getElementById("continue").disabled = false;
        }
      });
    });

    document.getElementById("continue").addEventListener("click", () => {
      state.step = "final";
      saveState();
      render();
    });
  }

  // Final level
  function renderFinal(){
    if(!has("WILL") || !has("YOU") || !has("BE") || !has("MY")){
      state.step = nextStepFromProgress();
      saveState();
      return render();
    }

    const solved = has("VALENTINE?");
    const showHint = (state.attemptsFinal || 0) >= 1;

    setScene(`
    <div class="kicker">Final</div>
    <div class="title">The Journal</div>
    <div class="muted">
The chamber fades behind you.
What remains is what you‚Äôve gathered.
    </div>

    <div class="divider"></div>

    <div class="muted" style="margin:0;">
The last word is sealed.
One word remains.
    </div>

    <div class="callout">
      <p class="prose">WILL<br>YOU<br>BE<br>MY<br><em>[ sealed ]</em></p>
    </div>

    <div class="divider"></div>

    <div class="muted" style="margin:0;">
Choose the word that is not claimed‚Ä¶ only asked.
    </div>

    <div class="choices" style="margin-top:12px;">
      <button class="choice" data-final="OATH">OATH</button>
      <button class="choice" data-final="FATE">FATE</button>
      <button class="choice" data-final="MINE">MINE</button>
      <button class="choice" data-final="VALENTINE?">VALENTINE?</button>
    </div>

    <div class="hint ${showHint ? "show" : ""}" id="hint">
Hint: The last word must be a question.
    </div>

    <div class="msg" id="msg"></div>

    <div class="divider"></div>

    <div class="input-row">
      <button id="open" ${solved ? "" : "disabled"}>üìñ Open the journal</button>
    </div>

    <div class="note">
When the seal breaks, the journal will show the full question. If the journal does not open, you can open it with the button above.
    </div>
  `);

    const jBtn = document.getElementById("j");
    if (jBtn) jBtn.addEventListener("click", openJournal);

    const msg = document.getElementById("msg");
    const openBtn = document.getElementById("open");

    scene.querySelectorAll("button.choice[data-final]").forEach(btn => {
      btn.addEventListener("click", () => {
        const pick = btn.getAttribute("data-final");

        if(pick === "VALENTINE?"){
          msg.className = "msg ok";
          msg.textContent = "The wax seal warms, then softens.\nIt breaks without force.\nThe last word is revealed.";
          unlock("VALENTINE?");
          openBtn.disabled = false;
          setTimeout(openJournal, 5500);
        }else{
          state.attemptsFinal = (state.attemptsFinal || 0) + 1;
          saveState();
          document.getElementById("hint").classList.add("show");
          msg.className = "msg err";
          msg.textContent = "The seal does not yield.\nThis word is taken, this page is only asked.";
        }
      });
    });

    openBtn.addEventListener("click", openJournal);
  }


  // End screen
  function renderEnd(){
    setScene(`
        <div class="kicker">‚Äî</div>
        <div class="title"> </div>
        <div class="prose" style="margin:0;">${escapeHtml(state.endMessage).replace(/\n/g,"<br>")}</div>

        <div class="divider"></div>

        <div class="input-row">
          <button class="btn-ghost" id="j">üìñ Journal</button>
          <button id="restart">Restart</button>
        </div>
      `);

    document.getElementById("j").addEventListener("click", openJournal);
    document.getElementById("restart").addEventListener("click", resetState);
  }

  function escapeHtml(str){
    return (str || "").replace(/[&<>"']/g, s => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[s]));
  }

  
  if(state.step === "final" && has("VALENTINE?")){
   
  }else{
   
    const should = nextStepFromProgress();
    const order = ["start","l1","l2","l3","l4","final","end"];
    if(order.indexOf(should) > order.indexOf(state.step)){
      state.step = should;
      saveState();
    }
  }

  render();
</script>
</body>
</html>
